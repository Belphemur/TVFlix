// Generated by CoffeeScript 1.9.1
(function() {
  "use strict";
  (function($) {
    var $body, getImage, handleSearchRequest, handleSeasonInformation, handleSelectionShow, setSeasonInformation, setShowInformation, toggleLoadingScreen, traktApiRoot, traktClientId, traktRequest;
    $body = $('body');
    traktClientId = "2d40da7a6e42cd29c4b9bbef14e7acc208fc9c27c90a8242718f45effc4c73f6";
    traktApiRoot = 'http://api.staging.trakt.tv';

    /*
      Make request to the trakt API
     */
    traktRequest = function(endpoint, type) {
      type = type != null ? type : 'GET';
      return $.ajax({
        url: traktApiRoot + endpoint,
        type: type,
        dataType: 'json',
        headers: {
          'trakt-api-key': traktClientId,
          'trakt-api-version': 2
        }
      });
    };

    /*
      Loading Screen function
     */
    toggleLoadingScreen = function() {
      if ($body.hasClass('loading')) {
        return $body.removeClass('loading');
      } else {
        return $body.addClass('loading');
      }
    };

    /*
      Do the API Call on the search and process the results.
      AutoComplete need to have an object with value and label set
     */
    handleSearchRequest = function(request, responseCallback) {
      var query;
      query = request.term;
      return $.ajax({
        type: "GET",
        data: {
          query: query
        },
        url: "/tvflix/search/shows",
        dataType: "json",
        global: false
      }).success(function(json) {
        var responseArray;
        responseArray = [];
        json._embedded.forEach(function(show) {
          var toAdd;
          toAdd = {};
          $.extend(toAdd, show, {
            showLabel: show.label,
            label: show.title,
            value: show.title
          });
          return responseArray.push(toAdd);
        });
        return responseCallback(responseArray);
      }).fail(function(jqXHR) {
        if (jqXHR.status !== 404) {
          return console.error(jqXHR);
        }
      });
    };

    /*
      Retrieve an image from Trakt
     */
    getImage = function(label, callback) {
      return traktRequest('/shows/' + label + '?extended=images').success(function(data) {
        return callback(null, data.images.thumb.full);
      }).fail(function(XHR) {
        return callback(XHR);
      });
    };

    /*
      Set the Show information (HTML)
     */
    setShowInformation = function(item, callback) {
      $('#startYear').text(item.start_year);
      $('#showTitle').text(item.title);
      $('#endYear').text(item.end_year);
      $('#channel').text(item.channel);
      $('#summary').text(item.summary);
      return getImage(item.showLabel, function(error, imgUrl) {
        if (error) {
          console.log(error);
          $('#showImage img').attr('src', '/static/image/no-image.png');
          return callback();
        }
        $('#showImage img').attr('src', imgUrl);
        return callback();
      });
    };

    /*
      Set the HTML with the sessions information
     */
    handleSeasonInformation = function(seasons) {
      var seasonList;
      seasonList = $("#showSeasons ul");
      return seasons.forEach(function(season) {
        var li, link;
        link = $('<a>', {
          "class": 'season',
          href: '#',
          'data-episodes': season._links.episode.href
        }).text('Season ' + season.number);
        li = $('<li>').html(link);
        return seasonList.append(li);
      });
    };

    /*
      Do the request to get season information
     */
    setSeasonInformation = function(item, callback) {
      var seasonList;
      seasonList = $("#showSeasons ul");
      seasonList.html('');
      return $.ajax({
        url: item._links.seasons.href,
        type: 'GET',
        dataType: 'json'
      }).success(function(data) {
        return handleSeasonInformation(data._embedded.season);
      }).complete(function() {
        return callback();
      });
    };
    handleSelectionShow = function(event, ui) {
      toggleLoadingScreen();
      $('#placeholder').hide();
      return setShowInformation(ui.item, function() {
        return setSeasonInformation(ui.item, function() {
          $('#showContainer').fadeIn();
          return setTimeout(toggleLoadingScreen, 500);
        });
      });
    };
    $("input[data-toggle='tooltip'][type='search']").tooltip();
    return $('#searchShows').autocomplete({
      source: handleSearchRequest,
      minLength: 2,
      select: handleSelectionShow
    });
  })(jQuery);

}).call(this);

//# sourceMappingURL=search.js.map
